<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NNA Registry Taxonomy Mapping Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.6;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
    }
    h1 {
      color: #2563eb;
      margin-bottom: 1rem;
    }
    h2 {
      color: #4b5563;
      margin-top: 2rem;
    }
    .card {
      background-color: #f9fafb;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .input-group {
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    input, select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 16px;
    }
    button {
      background-color: #2563eb;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 1rem;
    }
    button:hover {
      background-color: #1d4ed8;
    }
    .result {
      margin-top: 2rem;
      padding: 16px;
      background-color: #f3f4f6;
      border-radius: 4px;
      border-left: 4px solid #2563eb;
    }
    .success {
      border-left-color: #10b981;
      background-color: #ecfdf5;
    }
    .error {
      border-left-color: #ef4444;
      background-color: #fef2f2;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      text-align: left;
    }
    th {
      background-color: #f3f4f6;
      font-weight: 600;
    }
    .test-case.passed {
      background-color: #ecfdf5;
    }
    .test-case.failed {
      background-color: #fef2f2;
    }
    .status-icon {
      font-weight: bold;
      margin-right: 5px;
    }
    .status-icon.passed::after {
      content: "✅";
    }
    .status-icon.failed::after {
      content: "❌";
    }
  </style>
</head>
<body>
  <h1>NNA Registry Taxonomy Mapping Test</h1>
  <p>This page tests the taxonomy mapping functionality for the NNA Registry, focusing on the critical W.BCH.SUN case.</p>
  
  <div class="card">
    <h2>Manual Testing</h2>
    <div class="input-group">
      <label for="hfn">Human-Friendly Name (HFN):</label>
      <input type="text" id="hfn" placeholder="e.g., W.BCH.SUN.001" value="W.BCH.SUN.001">
    </div>
    <button id="convert-btn">Convert to MFA</button>
    <div id="manual-result" class="result">Result will appear here...</div>
  </div>
  
  <div class="card">
    <h2>Automatic Tests</h2>
    <button id="run-tests-btn">Run All Tests</button>
    <div id="test-results">
      <table>
        <thead>
          <tr>
            <th>Test Case</th>
            <th>HFN</th>
            <th>Expected MFA</th>
            <th>Result</th>
          </tr>
        </thead>
        <tbody id="test-results-body">
          <!-- Test results will be inserted here -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Mock implementation of the taxonomy service
    const taxonomyService = {
      // Map layer codes to numeric values
      LAYER_NUMERIC_CODES: {
        'G': '1',
        'S': '2', 
        'L': '3',
        'M': '4',
        'W': '5',
        'B': '6',
        'P': '7',
        'T': '8',
        'C': '9',
        'R': '10'
      },
      
      // Map category codes to numeric codes
      CATEGORY_NUMERIC_CODES: {
        'POP': '001',
        'ROK': '002',
        'HIP': '003',
        'BCH': '004',
        'DNC': '004',
        'DSF': '005',
        'RNB': '006',
        'JZZ': '007'
      },
      
      // Map subcategory codes to numeric codes
      SUBCATEGORY_NUMERIC_CODES: {
        'BAS': '001',
        'TRO': '002',
        'SUN': '003', // Key fix for W.BCH.SUN
        'WAV': '004',
        'HPM': '007'  // For S.POP.HPM
      },
      
      // Fixed mappings for special cases
      SPECIAL_MAPPINGS: {
        'W.BCH.SUN': '5.004.003'
      },
      
      // Convert HFN to MFA
      convertHFNtoMFA(hfn) {
        try {
          // Parse the HFN
          const parts = hfn.split('.');
          if (parts.length < 3) {
            console.warn(`Invalid HFN format: ${hfn}`);
            return '';
          }
          
          const [layer, categoryCode, subcategoryCode, sequential, ...rest] = parts;
          
          // Check for special case mapping first
          const specialCaseKey = `${layer}.${categoryCode}.${subcategoryCode}`;
          if (this.SPECIAL_MAPPINGS[specialCaseKey]) {
            console.log(`Using special case mapping for ${specialCaseKey}: ${this.SPECIAL_MAPPINGS[specialCaseKey]}`);
            // Append sequential and any other parts
            return `${this.SPECIAL_MAPPINGS[specialCaseKey]}.${sequential}${rest.length > 0 ? '.' + rest.join('.') : ''}`;
          }
          
          // Get numeric codes
          const layerNumeric = this.LAYER_NUMERIC_CODES[layer] || '0';
          const categoryNumeric = this.CATEGORY_NUMERIC_CODES[categoryCode] || '001';
          const subcategoryNumeric = this.SUBCATEGORY_NUMERIC_CODES[subcategoryCode] || '001';
          
          // Special handling for S.POP.HPM
          if (layer === 'S' && categoryCode === 'POP' && subcategoryCode === 'HPM') {
            console.log('Special handling for S.POP.HPM: 2.001.007');
            return `2.001.007.${sequential}${rest.length > 0 ? '.' + rest.join('.') : ''}`;
          }
          
          // Construct MFA
          const mfa = `${layerNumeric}.${categoryNumeric}.${subcategoryNumeric}.${sequential}${rest.length > 0 ? '.' + rest.join('.') : ''}`;
          
          return mfa;
        } catch (error) {
          console.error(`Error converting HFN to MFA: ${error}`);
          return '';
        }
      }
    };

    // Set up manual testing
    document.getElementById('convert-btn').addEventListener('click', function() {
      const hfn = document.getElementById('hfn').value.trim();
      const resultElement = document.getElementById('manual-result');
      
      if (!hfn) {
        resultElement.textContent = 'Please enter a Human-Friendly Name (HFN)';
        resultElement.className = 'result error';
        return;
      }
      
      try {
        const mfa = taxonomyService.convertHFNtoMFA(hfn);
        
        if (mfa) {
          resultElement.innerHTML = `
            <strong>HFN:</strong> ${hfn}<br>
            <strong>MFA:</strong> ${mfa}
          `;
          resultElement.className = 'result success';
        } else {
          resultElement.textContent = 'Could not convert HFN to MFA. Invalid format or unsupported mapping.';
          resultElement.className = 'result error';
        }
      } catch (error) {
        resultElement.textContent = `Error: ${error.message}`;
        resultElement.className = 'result error';
      }
    });
    
    // Set up automated tests
    document.getElementById('run-tests-btn').addEventListener('click', function() {
      const testCases = [
        { hfn: 'W.BCH.SUN.001', expected: '5.004.003.001', description: 'W.BCH.SUN → 5.004.003.001' },
        { hfn: 'G.POP.BAS.001', expected: '1.001.001.001', description: 'G.POP.BAS → 1.001.001.001' },
        { hfn: 'S.POP.HPM.001', expected: '2.001.007.001', description: 'S.POP.HPM → 2.001.007.001' },
        { hfn: 'L.STG.RED.001', expected: '3.001.001.001', description: 'L.STG.RED → 3.001.001.001' },
        { hfn: 'W.BCH.SUN.999.mp4', expected: '5.004.003.999.mp4', description: 'W.BCH.SUN with file type' }
      ];
      
      const resultsBody = document.getElementById('test-results-body');
      resultsBody.innerHTML = '';
      
      for (const testCase of testCases) {
        const actual = taxonomyService.convertHFNtoMFA(testCase.hfn);
        const passed = actual === testCase.expected;
        
        const row = document.createElement('tr');
        row.className = `test-case ${passed ? 'passed' : 'failed'}`;
        row.innerHTML = `
          <td><span class="status-icon ${passed ? 'passed' : 'failed'}"></span>${testCase.description}</td>
          <td>${testCase.hfn}</td>
          <td>${testCase.expected}</td>
          <td>${actual || '<empty>'}</td>
        `;
        
        resultsBody.appendChild(row);
      }
    });
    
    // Run tests automatically on page load
    window.addEventListener('DOMContentLoaded', function() {
      document.getElementById('run-tests-btn').click();
      document.getElementById('convert-btn').click();
    });
  </script>
</body>
</html>